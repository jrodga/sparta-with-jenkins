pipeline {
  agent any

  environment {
    IMAGE_NAME = "jrodga1604/sparta-app"
    DOCKER_CREDS = "dockerhub-creds"
    GIT_CREDS = "github-creds"
    EC2_IP = "YOUR_EC2_PUBLIC_IP"
  }

  parameters {
    string(name: 'FEATURE_BRANCH', defaultValue: '', description: 'Feature branch to merge')
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    // ===============================
    // JOB 1 → CI (feature branches)
    // ===============================

    stage('Build & Push (Feature Job Only)') {
      when {
        expression { env.JOB_NAME == "sparta-ci-feature" }
      }
      steps {
        dir('app') {
          sh """
            docker buildx inspect multi-builder >/dev/null 2>&1 || docker buildx create --use --name multi-builder
            docker buildx use multi-builder

            docker buildx build \
              --platform linux/amd64 \
              -t $IMAGE_NAME:$BUILD_NUMBER \
              -t $IMAGE_NAME:latest \
              --push .
          """
        }
      }
    }

    stage('Trigger Promotion') {
      when {
        expression { env.JOB_NAME == "sparta-ci-feature" }
      }
      steps {
        build job: 'sparta-promote-main',
              parameters: [
                string(name: 'FEATURE_BRANCH', value: env.BRANCH_NAME)
              ],
              wait: true
      }
    }

    // ===============================
    // JOB 2 → Promotion + Deploy
    // ===============================

    stage('Merge to Main (Promotion Only)') {
      when {
        expression { env.JOB_NAME == "sparta-promote-main" }
      }
      steps {
        withCredentials([usernamePassword(
          credentialsId: GIT_CREDS,
          usernameVariable: 'GIT_USER',
          passwordVariable: 'GIT_TOKEN'
        )]) {
          sh """
            git config user.email "jenkins@local"
            git config user.name "Jenkins"

            git fetch origin

            git checkout main
            git pull https://$GIT_USER:$GIT_TOKEN@github.com/jrodga/sparta-with-jenkins.git main

            git merge origin/${FEATURE_BRANCH}

            git push https://$GIT_USER:$GIT_TOKEN@github.com/jrodga/sparta-with-jenkins.git main
          """
        }
      }
    }

    stage('Deploy to EC2 (Promotion Only)') {
      when {
        expression { env.JOB_NAME == "sparta-promote-main" }
      }
      steps {
        sshagent(credentials: ['ec2-ssh']) {
          sh """
            ssh -o StrictHostKeyChecking=no ubuntu@$EC2_IP '
              docker pull $IMAGE_NAME:latest &&
              docker compose down &&
              docker compose up -d
            '
          """
        }
      }
    }

  }
}
