pipeline {
  agent any

  environment {
    IMAGE_NAME = "jrodga1604/sparta-app"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build and Push Docker Image (amd64)') {
      steps {
        dir('app') {
          sh """
            docker buildx create --use --name multi-builder || true
            docker buildx build \
              --platform linux/amd64 \
              -t $IMAGE_NAME:$BUILD_NUMBER \
              -t $IMAGE_NAME:latest \
              --push .
          """
        }
      }
    }
    stage('Deploy to EC2') {
  when {
    branch 'main'
  }
  steps {
    sshagent(credentials: ['ec2-ssh']) {
      sh """
        ssh -o StrictHostKeyChecking=no ubuntu@63.33.64.20 '
          docker pull jrodga1604/sparta-app:latest &&
          docker compose down &&
          docker compose up -d
        '
      """
    }
  }
}
  }
}
